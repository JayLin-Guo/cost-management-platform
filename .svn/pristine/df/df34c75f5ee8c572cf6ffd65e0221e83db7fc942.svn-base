<template>
  <div class="workflow-container">
    <!-- 顶部工具栏 -->
    <div class="workflow-header">
      <div class="header-left">
        <span class="label">项目名称：</span>
        <span class="project-name">{{ projectInfo?.projectName || '加载中...' }}</span>
      </div>
      <div class="header-right">
        <span class="label">任务名称：</span>
        <el-select
          v-model="selectedTaskId"
          placeholder="请选择任务"
          style="width: 400px"
          @change="handleTaskChange"
        >
          <el-option
            v-for="task in taskList"
            :key="task.id"
            :label="task.taskName"
            :value="task.id"
          />
        </el-select>
        <el-button type="primary" :icon="Plus" circle title="新增任务" @click="handleCreateTask" />
        <el-button
          type="primary"
          :icon="Edit"
          circle
          title="编辑任务"
          :disabled="!selectedTaskId"
          @click="handleEditTask"
        />
        <el-button
          type="danger"
          :icon="Delete"
          circle
          title="删除任务"
          :disabled="!selectedTaskId"
          @click="handleDeleteTask"
        />
      </div>
    </div>

    <!-- 工作流程区域 -->
    <div v-if="projectInfo" class="workflow-content">
      <div class="workflow-section">
        <el-empty v-if="!selectedTaskId" description="请选择任务查看工作流程" />
        <div v-else class="workflow-canvas">
          <p>任务ID: {{ selectedTaskId }}</p>
          <el-empty description="工作流程功能开发中..." />
        </div>
      </div>
    </div>

    <div v-else class="loading-container">
      <el-skeleton :rows="8" animated />
    </div>

    <!-- 任务对话框 -->
    <TaskDialog
      ref="taskDialogRef"
      v-model="taskDialogVisible"
      :project-id="Number(route.query.projectId)"
      :task-data="currentTask"
      @success="handleTaskSuccess"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRouter, useRoute } from 'vue-router'
import { ElMessage, ElMessageBox } from 'element-plus'
import { Plus, Edit, Delete } from '@element-plus/icons-vue'
import { getProjectDetail, type ProjectItem } from '@/api/project'
import * as taskAPI from '@/api/task/index'
import type { TaskItem } from '@/api/task/index'
import TaskDialog from './components/TaskDialog.vue'

const router = useRouter()
const route = useRoute()

const projectInfo = ref<ProjectItem | null>(null)
const taskList = ref<TaskItem[]>([])
const selectedTaskId = ref<number | undefined>(undefined)
const currentTask = ref<TaskItem | null>(null)
const taskDialogVisible = ref(false)
const taskDialogRef = ref<InstanceType<typeof TaskDialog>>()

// 获取项目详情
const fetchProjectDetail = async () => {
  const projectId = route.query.projectId as string
  if (!projectId) {
    ElMessage.warning('缺少项目ID参数')
    router.push('/task')
    return
  }

  try {
    const result = await getProjectDetail(Number(projectId))
    if (result) {
      projectInfo.value = result
      // 获取任务列表
      await fetchTaskList(Number(projectId))
    } else {
      ElMessage.error('项目不存在')
      router.push('/task')
    }
  } catch (error: any) {
    ElMessage.error(error.message || '获取项目详情失败')
    router.push('/task')
  }
}

// 获取任务列表
const fetchTaskList = async (projectId: number) => {
  try {
    const tasks = await taskAPI.getProjectTasks(projectId)
    taskList.value = tasks
    // 如果有任务，默认选中第一个
    if (tasks.length > 0) {
      selectedTaskId.value = tasks[0].id
    }
  } catch (error: any) {
    ElMessage.error(error.message || '获取任务列表失败')
  }
}

// 任务切换
const handleTaskChange = (taskId: number) => {
  selectedTaskId.value = taskId
  // TODO: 加载对应任务的工作流程
}

// 新增任务
const handleCreateTask = () => {
  currentTask.value = null
  taskDialogVisible.value = true
}

// 编辑任务
const handleEditTask = () => {
  const task = taskList.value.find((t) => t.id === selectedTaskId.value)
  if (task) {
    currentTask.value = task
    taskDialogVisible.value = true
  }
}

// 删除任务
const handleDeleteTask = async () => {
  const task = taskList.value.find((t) => t.id === selectedTaskId.value)
  if (!task) return

  try {
    await ElMessageBox.confirm(`确定要删除任务"${task.taskName}"吗？`, '提示', {
      confirmButtonText: '确定',
      cancelButtonText: '取消',
      type: 'warning',
    })

    await taskAPI.deleteTask(task.id)
    ElMessage.success('删除成功')
    // 刷新任务列表
    await fetchTaskList(Number(route.query.projectId))
    selectedTaskId.value = taskList.value.length > 0 ? taskList.value[0].id : undefined
  } catch (error: any) {
    if (error !== 'cancel') {
      ElMessage.error(error.message || '删除失败')
    }
  }
}

// 任务对话框成功回调
const handleTaskSuccess = async () => {
  const formData = taskDialogRef.value?.formData
  if (!formData) return

  try {
    if (currentTask.value) {
      // 编辑
      await taskAPI.updateTask(currentTask.value.id, {
        ...formData,
        projectId: Number(route.query.projectId),
      })
      ElMessage.success('更新成功')
    } else {
      // 新建
      const newTask = await taskAPI.createTask({
        ...formData,
        projectId: Number(route.query.projectId),
      })
      ElMessage.success('创建成功')
      selectedTaskId.value = newTask.id
    }
    // 刷新任务列表
    await fetchTaskList(Number(route.query.projectId))
  } catch (error: any) {
    ElMessage.error(error.message || '操作失败')
  }
}

onMounted(() => {
  fetchProjectDetail()
})
</script>

<style scoped lang="scss">
.workflow-container {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 64px);
  background: var(--body-background);

  .workflow-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 24px;
    background: var(--component-background);
    border-bottom: 1px solid var(--border-color-light);
    flex-shrink: 0;

    .header-left,
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;

      .label {
        font-size: 14px;
        color: var(--text-color-secondary);
        white-space: nowrap;
      }

      .project-name {
        font-size: 16px;
        font-weight: 500;
        color: var(--text-color);
      }
    }

    .header-right {
      .el-button {
        &:not(:disabled) {
          &:hover {
            transform: scale(1.1);
            transition: transform 0.2s;
          }
        }
      }
    }
  }

  .workflow-content {
    flex: 1;
    overflow: auto;
    padding: 16px 24px;

    .workflow-section {
      height: 100%;
      background: var(--component-background);
      border: 1px solid var(--border-color-light);
      border-radius: 8px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;

      .workflow-canvas {
        width: 100%;
        height: 100%;
      }
    }
  }

  .loading-container {
    flex: 1;
    padding: 24px;
    background: var(--component-background);
    border: 1px solid var(--border-color-light);
    border-radius: 8px;
    margin: 16px 24px;
  }
}
</style>
