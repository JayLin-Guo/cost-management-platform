# å·¥ä½œæµæ•°æ®ç»“æ„è®¾è®¡æ–¹æ¡ˆ

## ğŸ¯ ä¸€ã€æ ¸å¿ƒè®¾è®¡é—®é¢˜åˆ†æ

### 1.1 åŸæœ‰æ•°æ®ç»“æ„ç—›ç‚¹
- **é©³å›é€»è¾‘å¤æ‚åŒ–**ï¼šéœ€è¦åˆ›å»ºé¢å¤–çš„endèŠ‚ç‚¹å¤„ç†é©³å›
- **åŒä¸€å¤©å¤šè½®äº¤äº’éš¾å¤„ç†**ï¼šfrom/toå•ä¸€å…³ç³»æ— æ³•è¡¨è¾¾å¤æ‚æµç¨‹
- **è¿æ¥çº¿æ–¹å‘æ··ä¹±**ï¼šç¼ºä¹æ˜ç¡®çš„è§†è§‰é€»è¾‘è§„èŒƒ
- **ç»“æŸçŠ¶æ€åˆ¤æ–­ä¸å‡†ç¡®**ï¼šé©³å›è¢«è¯¯è®¤ä¸ºæ˜¯ç»“æŸçŠ¶æ€

### 1.2 æ–°éœ€æ±‚æŒ‘æˆ˜
- **åŠ¨ç”»èŠ‚ç‚¹é›†æˆ**ï¼šéœ€è¦å¾ªç¯æ’­æ”¾çš„è§†è§‰åé¦ˆç³»ç»Ÿ
- **å¤æ‚äº¤äº’å¤„ç†**ï¼šåŒä¸€å¤©å†…å¤šæ¬¡æäº¤ã€é©³å›ã€é‡æ–°å¤„ç†
- **æ—¶é—´è½´å¸ƒå±€ä¼˜åŒ–**ï¼šè‡ªé€‚åº”ç®—æ³•éœ€è¦ç²¾ç¡®æ§åˆ¶ç©ºé—´é¢„ç•™

## ğŸ—ï¸ äºŒã€æœ€ç»ˆæ•°æ®ç»“æ„è®¾è®¡

### 2.1 æ ¸å¿ƒWorkflowNodeç»“æ„
```typescript
interface WorkflowNode {
  // === åŸºç¡€ä¿¡æ¯ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰ ===
  id: string                    // èŠ‚ç‚¹å”¯ä¸€æ ‡è¯†
  reviewerId: string            // å®¡æ ¸äººID
  timePointId: string           // æ—¶é—´ç‚¹ID
  fileId: string               // æ–‡ä»¶ID
  title: string                // èŠ‚ç‚¹æ ‡é¢˜
  
  // === çŠ¶æ€ä¿¡æ¯ï¼ˆç®€åŒ–ä¼˜åŒ–ï¼‰ ===
  status: 'pending' | 'processing' | 'approved' | 'rejected' | 'completed'
  stateInfo: string            // çŠ¶æ€æè¿°
  
  // === è¿æ¥å…³ç³»ï¼ˆæ ¸å¿ƒåˆ›æ–°ï¼‰ ===
  connections: Connection[]     // å¤šè¿æ¥æ•°ç»„ï¼ˆæ›¿ä»£å•ä¸€from/toï¼‰
  
  // === äº¤äº’é…ç½®ï¼ˆä¿æŒä¸å˜ï¼‰ ===
  rightAction: RightAction[]    // å³é”®èœå•é…ç½®
  
  // === æ‰©å±•å­—æ®µ ===
  nodeType?: 'normal' | 'start' | 'milestone' | 'end'
  canContinueAfterReject?: boolean
  
  // === åŒä¸€å¤©å¤šè½®äº¤äº’æ”¯æŒ ===
  timeSequence?: number         // åŒå¤©å†…æ“ä½œåºå·
  positionInDay?: number        // åŒå¤©å†…æ˜¾ç¤ºä½ç½®
  timeDetail?: string          // å…·ä½“æ—¶é—´ "14:00"
  
  // === åŠ¨ç”»ç³»ç»Ÿå…³é”®å­—æ®µ ===
  isModified: boolean          // ğŸ”‘ å…³é”®ï¼šèŠ‚ç‚¹æ˜¯å¦è¢«ä¿®æ”¹è¿‡
  lastModifiedTime?: string    // æœ€åä¿®æ”¹æ—¶é—´
  modificationCount?: number   // ä¿®æ”¹æ¬¡æ•°
  hasBeenVisited?: boolean     // åŠ¨ç”»è®¿é—®æ ‡è®°ï¼ˆé‡å¯æ—¶é‡ç½®ï¼‰
  currentVisualState?: 'default' | 'overlapping' | 'visited'
}
```

### 2.2 è¿æ¥å…³ç³»ç»“æ„ï¼ˆæ ¸å¿ƒåˆ›æ–°ï¼‰
```typescript
interface Connection {
  id: string                   // è¿æ¥å”¯ä¸€æ ‡è¯†
  fromNodeId: string          // èµ·å§‹èŠ‚ç‚¹
  toNodeId: string           // ç›®æ ‡èŠ‚ç‚¹
  type: 'forward' | 'reject' | 'reprocess' | 'parallel' | 'loop'
  label: string              // è¿æ¥çº¿æ˜¾ç¤ºæ–‡æ¡ˆ
  condition?: string         // è¿æ¥æ¡ä»¶
  
  // === å¤šè½®äº¤äº’å…³é”®æ”¯æŒ ===
  actionSequence?: number    // æ“ä½œåºå·ï¼ˆåŒå¤©å†…æ’åºï¼‰
  actionTime?: string       // æ“ä½œæ—¶é—´ "14:00"
  status?: 'active' | 'completed' | 'failed'
  isCurrentAction?: boolean // æ˜¯å¦ä¸ºå½“å‰æ´»è·ƒæ“ä½œ
}
```

### 2.3 ç»“æŸèŠ‚ç‚¹ç‰¹æ®Šå¤„ç†
```typescript
interface EndNode extends WorkflowNode {
  nodeType: 'end'
  isWorkflowEnd: boolean
  endType: 'success' | 'cancelled'  // æ³¨æ„ï¼šä¸åŒ…å«'rejected'
  finalResult?: string
}
```

### 2.4 æ—¶é—´ç‚¹æ•°æ®ç»“æ„
```typescript
interface TimePoint {
  id: string                   // æ—¶é—´ç‚¹ID
  date: string                 // æ—¥æœŸæˆ–é—´éš”æ ‡è¯†
  label: string                // æ˜¾ç¤ºæ ‡ç­¾
  isInterval?: boolean         // æ˜¯å¦ä¸ºæ—¶é—´é—´éš”
  spanDays?: number           // é—´éš”å¤©æ•°
  displayWidth?: number       // æ˜¾ç¤ºå®½åº¦ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰
  hasNodes?: boolean          // æ˜¯å¦æœ‰èŠ‚ç‚¹ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰
  nodeCount?: number          // èŠ‚ç‚¹æ•°é‡ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰
  isEndPoint?: boolean        // æ˜¯å¦ä¸ºç»“æŸæ—¶é—´ç‚¹
}
```

## ğŸ¨ ä¸‰ã€åŠ¨ç”»èŠ‚ç‚¹ç³»ç»Ÿè®¾è®¡

### 3.1 æ ¸å¿ƒäº¤äº’æœºåˆ¶
- **å¾ªç¯æ’­æ”¾**ï¼šåŠ¨ç”»èŠ‚ç‚¹æŒç»­æ²¿å·¥ä½œæµè·¯å¾„ç§»åŠ¨
- **ä¸‰ç§è§†è§‰çŠ¶æ€**ï¼š
  - `default`ï¼šç©ºå¿ƒè¾¹æ¡†ï¼Œé€æ˜åº¦0.7ï¼ˆç­‰å¾…å¡«å……æ„Ÿï¼‰
  - `overlapping`ï¼šå®å¿ƒç»¿è‰²ï¼ˆåŠ¨ç”»èŠ‚ç‚¹æ»‘å…¥ä¸”isModified=trueï¼‰
  - `visited`ï¼šæ©™è‰²åŠé€æ˜ï¼ˆåŠ¨ç”»èŠ‚ç‚¹ç¦»å¼€åçš„æ ‡è®°ï¼‰

### 3.2 ç»Ÿä¸€èŠ‚ç‚¹åˆ›å»ºæ–¹æ³•
```typescript
// å®¡æ ¸èŠ‚ç‚¹å’ŒåŠ¨ç”»èŠ‚ç‚¹ä½¿ç”¨åŒä¸€ä¸ªåˆ›å»ºæ–¹æ³•
function createUnifiedWorkflowNode(
  nodeData: WorkflowNode, 
  styleConfig: NodeStyleConfig
): RenderedNode {
  return {
    ...nodeData,
    visualStyle: calculateNodeStyle(nodeData, styleConfig),
    interactionHandlers: bindInteractionEvents(nodeData, styleConfig)
  }
}

interface NodeStyleConfig {
  type: 'static' | 'animated'           // é™æ€å®¡æ ¸èŠ‚ç‚¹ | åŠ¨æ€åŠ¨ç”»èŠ‚ç‚¹
  shape: 'square'                       // ç»Ÿä¸€æ­£æ–¹å½¢æ ·å¼
  currentState: NodeVisualState         // å½“å‰è§†è§‰çŠ¶æ€
  isAnimating?: boolean                 // æ˜¯å¦æ­£åœ¨åŠ¨ç”»ä¸­
  animationPosition?: {x: number, y: number}  // åŠ¨ç”»ä½ç½®åæ ‡
}
```

### 3.3 é¡¶éƒ¨æ§åˆ¶ç³»ç»Ÿ
```typescript
interface AnimationControlInterface {
  pause: () => void      // â¸ï¸ æš‚åœåŠ¨ç”»
  continue: () => void   // â–¶ï¸ ç»§ç»­æ’­æ”¾
  restart: () => void    // ğŸ”„ é‡ç½®æ‰€æœ‰æ ·å¼ï¼Œä»ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹
}
```

### 3.4 èŠ‚ç‚¹äº¤äº’é€»è¾‘
```typescript
// åŠ¨ç”»èŠ‚ç‚¹æ»‘å…¥å®¡æ ¸èŠ‚ç‚¹æ—¶
function onAnimationNodeEnter(targetNodeId: string) {
  const targetNode = findNodeById(targetNodeId)
  
  if (targetNode.isModified) {
    // èŠ‚ç‚¹è¢«ä¿®æ”¹è¿‡ï¼šå®¡æ ¸èŠ‚ç‚¹ä»"ç©ºå¿ƒ"å˜ä¸º"å®å¿ƒ"
    updateNodeVisualState(targetNodeId, 'overlapping')
  }
  // å¦‚æœèŠ‚ç‚¹æœªè¢«ä¿®æ”¹è¿‡ï¼Œä¿æŒé»˜è®¤æ ·å¼ä¸å˜
}

// åŠ¨ç”»èŠ‚ç‚¹ç¦»å¼€å®¡æ ¸èŠ‚ç‚¹æ—¶
function onAnimationNodeLeave(targetNodeId: string) {
  const targetNode = findNodeById(targetNodeId)
  
  if (targetNode.isModified) {
    // èŠ‚ç‚¹è¢«ä¿®æ”¹è¿‡ï¼šå˜ä¸ºè®¿é—®åæ ·å¼ï¼ˆæ©™è‰²åŠé€æ˜ï¼‰
    targetNode.hasBeenVisited = true
    updateNodeVisualState(targetNodeId, 'visited')
  } else {
    // èŠ‚ç‚¹æœªè¢«ä¿®æ”¹è¿‡ï¼šæ¢å¤é»˜è®¤æ ·å¼
    updateNodeVisualState(targetNodeId, 'default')
  }
}
```

## ğŸ§® å››ã€å¸ƒå±€è‡ªé€‚åº”ç®—æ³•

### 4.1 æ—¶é—´è½´å¸ƒå±€æ§åˆ¶ç®—æ³•
```typescript
function calculateTimelineLayout(nodes: WorkflowNode[], timePoints: TimePoint[]): TimelineLayoutConfig {
  // æ ¸å¿ƒé€»è¾‘ï¼šæŸ¥æ‰¾çœŸæ­£çš„ç»“æŸèŠ‚ç‚¹
  const realEndNodes = nodes.filter(node => 
    node.nodeType === 'end' && 
    (node.endType === 'success' || node.endType === 'cancelled')
  )
  
  const hasRealEndNode = realEndNodes.length > 0
  
  if (hasRealEndNode) {
    return {
      hasEndNode: true,
      shouldReserveSpace: false,     // çœŸæ­£ç»“æŸï¼Œä¸é¢„ç•™ç©ºé—´
      maxEndTimePoint: realEndNodes[0].timePointId,
      reservedSpaceWidth: 0
    }
  } else {
    // æµç¨‹æœªå®Œæˆæˆ–åªæ˜¯é©³å›çŠ¶æ€ï¼Œéœ€è¦é¢„ç•™ç©ºé—´
    return {
      hasEndNode: false,
      shouldReserveSpace: true,      // é¢„ç•™åç»­æ“ä½œç©ºé—´
      maxEndTimePoint: getLastActiveTimePoint(nodes, timePoints),
      reservedSpaceWidth: 200        // é¢„ç•™200px
    }
  }
}
```

### 4.2 è¿æ¥çº¿å¸ƒå±€ç®—æ³•
```typescript
function calculateConnectionPath(fromNode: WorkflowNode, toNode: WorkflowNode, connectionType: string) {
  if (fromNode.timePointId === toNode.timePointId) {
    // åŒä¸€å¤©å†…ï¼šå‚ç›´è¿æ¥ï¼ˆè¡¨ç¤ºå³æ—¶æ“ä½œï¼‰
    switch (connectionType) {
      case 'reject': return 'å‚ç›´å‘ä¸Š'      // é©³å›çº¿
      case 'reprocess': return 'å‚ç›´å‘ä¸‹'   // é‡æ–°å¤„ç†çº¿
      case 'forward': return 'å‚ç›´ä¸‹â†’æ°´å¹³â†’å‚ç›´ä¸Š' // åŒå¤©æäº¤çº¿
    }
  } else {
    // è·¨æ—¶é—´ç‚¹ï¼šæ°´å¹³è¿æ¥ï¼ˆè¡¨ç¤ºæ—¶é—´è·¨åº¦ï¼‰
    return 'æ°´å¹³ç›´çº¿'
  }
}
```

### 4.3 åŒä¸€å¤©å¤šèŠ‚ç‚¹å¸ƒå±€ç­–ç•¥
```typescript
function layoutSameDayNodes(timePointId: string, nodes: WorkflowNode[]) {
  const dayNodes = nodes.filter(node => node.timePointId === timePointId)
  
  // æŒ‰æ“ä½œåºå·å’Œå®¡æ ¸äººä½ç½®æ’åº
  dayNodes.sort((a, b) => {
    // ä¼˜å…ˆçº§1ï¼štimeSequenceï¼ˆæ“ä½œåºå·ï¼‰
    if (a.timeSequence !== undefined && b.timeSequence !== undefined) {
      return a.timeSequence - b.timeSequence
    }
    
    // ä¼˜å…ˆçº§2ï¼šå®¡æ ¸äººä½ç½®
    const reviewerA = getReviewerById(a.reviewerId)
    const reviewerB = getReviewerById(b.reviewerId)
    return (reviewerA?.position || 0) - (reviewerB?.position || 0)
  })
  
  // è®¡ç®—å‚ç›´ä½ç½®ï¼Œé¿å…é‡å 
  return dayNodes.map((node, index) => ({
    ...node,
    calculatedPosition: {
      x: getTimePointX(timePointId),
      y: getReviewerY(node.reviewerId) + (index * 60) // æ¯ä¸ªèŠ‚ç‚¹é—´éš”60px
    }
  }))
}
```

## ğŸ”„ äº”ã€åŠ¨ç”»è·¯å¾„æ„å»ºç®—æ³•

### 5.1 ä¸‰ç§è·¯å¾„æ„å»ºç­–ç•¥

#### ç­–ç•¥ä¸€ï¼šåŸºäºè¿æ¥å…³ç³»
```typescript
function buildConnectionBasedPath(nodes: WorkflowNode[]): string[] {
  // ä¼˜ç‚¹ï¼šä¸¥æ ¼æŒ‰ä¸šåŠ¡æµç¨‹
  // ç¼ºç‚¹ï¼šå¯èƒ½äº§ç”Ÿç¯è·¯
  const visited = new Set<string>()
  const path: string[] = []
  
  function dfs(nodeId: string) {
    if (visited.has(nodeId)) return
    visited.add(nodeId)
    path.push(nodeId)
    
    const node = findNodeById(nodeId)
    node.connections.forEach(conn => {
      if (conn.type === 'forward' || conn.type === 'reprocess') {
        dfs(conn.toNodeId)
      }
    })
  }
  
  return path
}
```

#### ç­–ç•¥äºŒï¼šåŸºäºæ—¶é—´ç‚¹
```typescript
function buildTimeBasedPath(nodes: WorkflowNode[], timePoints: TimePoint[]): string[] {
  // ä¼˜ç‚¹ï¼šæ—¶é—´é¡ºåºæ˜ç¡®ï¼Œé¿å…ç¯è·¯
  // ç¼ºç‚¹ï¼šå¯èƒ½å¿½ç•¥ä¸šåŠ¡å…³ç³»
  
  const sortedTimePoints = timePoints.sort((a, b) => 
    new Date(a.date).getTime() - new Date(b.date).getTime()
  )
  
  const path: string[] = []
  sortedTimePoints.forEach(timePoint => {
    const timePointNodes = nodes
      .filter(node => node.timePointId === timePoint.id)
      .sort((a, b) => (a.timeSequence || 0) - (b.timeSequence || 0))
    
    timePointNodes.forEach(node => path.push(node.id))
  })
  
  return path
}
```

#### ç­–ç•¥ä¸‰ï¼šæ··åˆæ’åºï¼ˆæ¨èï¼‰
```typescript
function buildHybridPath(nodes: WorkflowNode[], timePoints: TimePoint[]): string[] {
  // ç»“åˆæ—¶é—´é¡ºåºå’Œè¿æ¥å…³ç³»çš„ä¼˜åŠ¿
  const timeBasePath = buildTimeBasedPath(nodes, timePoints)
  const optimizedPath = optimizePathByConnections(timeBasePath, nodes)
  
  return optimizedPath
}

function optimizePathByConnections(timePath: string[], nodes: WorkflowNode[]): string[] {
  // åœ¨ä¿æŒæ—¶é—´é¡ºåºçš„å‰æä¸‹ï¼Œä¼˜åŒ–åŒä¸€å¤©å†…çš„è®¿é—®é¡ºåº
  const groupedByTimePoint = groupBy(timePath, nodeId => {
    const node = findNodeById(nodeId)
    return node.timePointId
  })
  
  const optimizedPath: string[] = []
  
  Object.values(groupedByTimePoint).forEach(dayNodes => {
    // åŒä¸€å¤©å†…æŒ‰è¿æ¥å…³ç³»å’Œå®¡æ ¸äººä½ç½®æ’åº
    const sortedDayNodes = sortNodesByBusinessLogic(dayNodes, nodes)
    optimizedPath.push(...sortedDayNodes)
  })
  
  return optimizedPath
}
```

### 5.2 è·¯å¾„éªŒè¯å’Œå®¹é”™
```typescript
function validateAnimationPath(path: string[], nodes: WorkflowNode[]): ValidationResult {
  const issues: string[] = []
  
  for (let i = 0; i < path.length - 1; i++) {
    const currentNodeId = path[i]
    const nextNodeId = path[i + 1]
    
    const currentNode = nodes.find(n => n.id === currentNodeId)
    const nextNode = nodes.find(n => n.id === nextNodeId)
    
    if (!currentNode || !nextNode) {
      issues.push(`èŠ‚ç‚¹ä¸å­˜åœ¨: ${currentNodeId} -> ${nextNodeId}`)
      continue
    }
    
    // æ£€æŸ¥è¿æ¥å…³ç³»æˆ–åŒä¸€æ—¶é—´ç‚¹
    const hasDirectConnection = currentNode.connections.some(conn => 
      conn.toNodeId === nextNodeId
    )
    const sameTimePoint = currentNode.timePointId === nextNode.timePointId
    
    if (!hasDirectConnection && !sameTimePoint) {
      issues.push(`ç¼ºå°‘è¿æ¥å…³ç³»: ${currentNodeId} -> ${nextNodeId}`)
    }
  }
  
  return {
    isValid: issues.length === 0,
    issues,
    suggestedFixes: generatePathFixes(issues, nodes)
  }
}

// è‡ªåŠ¨ä¿®å¤è·¯å¾„é—®é¢˜
function autoFixAnimationPath(path: string[], nodes: WorkflowNode[]): string[] {
  const validation = validateAnimationPath(path, nodes)
  
  if (validation.isValid) return path
  
  console.warn('åŠ¨ç”»è·¯å¾„å­˜åœ¨é—®é¢˜ï¼Œå°è¯•è‡ªåŠ¨ä¿®å¤:', validation.issues)
  
  // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨æ—¶é—´é¡ºåºä½œä¸ºå¤‡é€‰è·¯å¾„
  return buildTimeBasedPath(nodes, timePoints)
}
```

## ğŸ® å…­ã€é‡æ–°å¼€å§‹åŠŸèƒ½å®ç°

```typescript
class EnhancedAnimationController {
  // é‡æ–°å¼€å§‹åŠ¨ç”»ï¼ˆå…³é”®æ–¹æ³•ï¼‰
  restart(): void {
    console.log('ğŸ”„ æ‰§è¡ŒåŠ¨ç”»é‡æ–°å¼€å§‹...')
    
    // 1. ç«‹å³åœæ­¢å½“å‰åŠ¨ç”»
    this.pause()
    
    // 2. æ‰§è¡Œæ ·å¼é‡ç½®åŠ¨ç”»
    this.executeStyleResetAnimation()
    
    // 3. é‡ç½®å†…éƒ¨çŠ¶æ€
    this.resetInternalState()
    
    // 4. æ˜¾ç¤ºé‡å¯åé¦ˆ
    this.showRestartFeedback()
    
    // 5. å»¶è¿Ÿé‡æ–°å¼€å§‹æ’­æ”¾ï¼ˆç­‰å¾…é‡ç½®åŠ¨ç”»å®Œæˆï¼‰
    setTimeout(() => {
      this.currentIndex = 0
      this.play()
      console.log('âœ… åŠ¨ç”»é‡æ–°å¼€å§‹å®Œæˆï¼Œä»ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹æ’­æ”¾')
    }, 300)
  }
  
  // æ‰§è¡Œæ ·å¼é‡ç½®åŠ¨ç”»
  private executeStyleResetAnimation(): void {
    this.nodes.forEach((node, index) => {
      // ä¸ºæ¯ä¸ªèŠ‚ç‚¹æ·»åŠ é‡ç½®åŠ¨ç”»ï¼Œç•¥å¾®é”™å¼€æ—¶é—´å¢åŠ è§†è§‰æ•ˆæœ
      setTimeout(() => {
        this.animateNodeToDefaultStyle(node.id)
      }, index * 50) // æ¯ä¸ªèŠ‚ç‚¹å»¶è¿Ÿ50ms
    })
  }
  
  // é‡ç½®å†…éƒ¨çŠ¶æ€
  private resetInternalState(): void {
    this.nodes.forEach(node => {
      // æ¸…é™¤è®¿é—®æ ‡è®°ï¼ˆæ³¨æ„ï¼šisModifiedä¿æŒä¸å˜ï¼‰
      node.hasBeenVisited = false
      node.currentVisualState = 'default'
    })
    
    // é‡ç½®åŠ¨ç”»æ§åˆ¶å™¨çŠ¶æ€
    this.currentIndex = 0
    this.isPlaying = false
  }
  
  // æ˜¾ç¤ºé‡å¯åé¦ˆ
  private showRestartFeedback(): void {
    // æ˜¾ç¤ºé‡å¯æŒ‡ç¤ºå™¨
    showNotification('ğŸ”„ åŠ¨ç”»å·²é‡æ–°å¼€å§‹ï¼Œæ‰€æœ‰èŠ‚ç‚¹æ ·å¼å·²é‡ç½®', {
      type: 'info',
      duration: 2000,
      position: 'top-center'
    })
    
    // åœ¨æ—¶é—´è½´ä¸Šæ˜¾ç¤ºé‡å¯æ³¢çº¹æ•ˆæœ
    triggerTimelineResetEffect()
  }
  
  // å•ä¸ªèŠ‚ç‚¹çš„é»˜è®¤æ ·å¼åŠ¨ç”»
  private animateNodeToDefaultStyle(nodeId: string): void {
    const nodeElement = document.getElementById(nodeId)
    if (!nodeElement) return
    
    // CSSåŠ¨ç”»ï¼šæ·¡å…¥åˆ°é»˜è®¤æ ·å¼
    nodeElement.style.transition = 'all 0.3s ease-out'
    nodeElement.style.border = '2px solid #ccc'
    nodeElement.style.background = 'transparent'
    nodeElement.style.opacity = '0.7'
    nodeElement.style.boxShadow = 'none'
    
    // æ·»åŠ é‡ç½®åŠ¨ç”»ç±»
    nodeElement.classList.add('node-resetting')
    
    setTimeout(() => {
      nodeElement.classList.remove('node-resetting')
    }, 300)
  }
}
```

## âš¡ ä¸ƒã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 7.1 åŠ¨ç”»æ€§èƒ½ä¼˜åŒ–é…ç½®
```typescript
interface PerformanceConfig {
  maxConcurrentAnimations: number      // æœ€å¤§å¹¶å‘åŠ¨ç”»æ•°ï¼š10
  animationFrameRate: number          // åŠ¨ç”»å¸§ç‡ï¼š60fps
  useCSSTransforms: boolean           // ä½¿ç”¨CSSå˜æ¢ï¼štrue
  enableGPUAcceleration: boolean      // å¯ç”¨GPUåŠ é€Ÿï¼štrue
  debounceInterval: number            // é˜²æŠ–é—´éš”ï¼š16ms
}
```

### 7.2 ä¼˜åŒ–çš„åŠ¨ç”»ç®¡ç†å™¨
```typescript
class OptimizedAnimationManager {
  private animationQueue: AnimationTask[] = []
  private activeAnimations: Map<string, Animation> = new Map()
  private performanceMonitor: PerformanceMonitor
  
  constructor(config: PerformanceConfig) {
    this.performanceMonitor = new PerformanceMonitor()
    this.initializeOptimizations(config)
  }
  
  // æ‰¹é‡å¤„ç†åŠ¨ç”»ï¼Œé¿å…æ€§èƒ½å³°å€¼
  processBatchAnimations(animations: AnimationTask[]): void {
    const batches = this.createAnimationBatches(animations, this.config.maxConcurrentAnimations)
    
    batches.forEach((batch, index) => {
      setTimeout(() => {
        this.executeBatch(batch)
      }, index * 100) // åˆ†æ‰¹æ‰§è¡Œï¼Œé¿å…æ€§èƒ½å³°å€¼
    })
  }
  
  // å†…å­˜ç®¡ç†
  cleanup(): void {
    // æ¸…ç†å·²å®Œæˆçš„åŠ¨ç”»
    this.activeAnimations.forEach((animation, nodeId) => {
      if (animation.playState === 'finished') {
        animation.cancel()
        this.activeAnimations.delete(nodeId)
      }
    })
    
    // åƒåœ¾å›æ”¶æ£€æŸ¥
    if (this.activeAnimations.size === 0) {
      this.performanceMonitor.triggerGC()
    }
  }
  
  // æ€§èƒ½ç›‘æ§
  private monitorPerformance(): void {
    this.performanceMonitor.track('animationFPS', () => {
      return this.calculateCurrentFPS()
    })
    
    this.performanceMonitor.track('memoryUsage', () => {
      return performance.memory?.usedJSHeapSize || 0
    })
  }
}
```

## ğŸ›¡ï¸ å…«ã€é”™è¯¯å¤„ç†å’Œå®¹é”™æœºåˆ¶

### 8.1 é”™è¯¯ç±»å‹å®šä¹‰
```typescript
type AnimationError = 
  | 'PATH_VALIDATION_FAILED'
  | 'NODE_NOT_FOUND' 
  | 'ANIMATION_TIMEOUT'
  | 'PERFORMANCE_DEGRADATION'
  | 'BROWSER_COMPATIBILITY'
```

### 8.2 é”™è¯¯æ¢å¤ç­–ç•¥
```typescript
class ErrorRecoveryManager {
  private fallbackStrategies: Map<AnimationError, () => void> = new Map()
  
  constructor() {
    this.initializeFallbackStrategies()
  }
  
  private initializeFallbackStrategies(): void {
    this.fallbackStrategies.set('PATH_VALIDATION_FAILED', () => {
      console.warn('åŠ¨ç”»è·¯å¾„éªŒè¯å¤±è´¥ï¼Œä½¿ç”¨æ—¶é—´é¡ºåºä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ')
      return this.useTimeBasedPath()
    })
    
    this.fallbackStrategies.set('NODE_NOT_FOUND', () => {
      console.warn('èŠ‚ç‚¹æœªæ‰¾åˆ°ï¼Œè·³è¿‡è¯¥èŠ‚ç‚¹ç»§ç»­åŠ¨ç”»')
      return this.skipInvalidNode()
    })
    
    this.fallbackStrategies.set('ANIMATION_TIMEOUT', () => {
      console.warn('åŠ¨ç”»è¶…æ—¶ï¼Œé‡ç½®ä¸ºé»˜è®¤çŠ¶æ€')
      return this.resetToDefaultState()
    })
    
    this.fallbackStrategies.set('PERFORMANCE_DEGRADATION', () => {
      console.warn('æ€§èƒ½ä¸‹é™ï¼Œé™ä½åŠ¨ç”»è´¨é‡')
      return this.reduceAnimationQuality()
    })
  }
  
  handleError(error: AnimationError, context: any): void {
    const strategy = this.fallbackStrategies.get(error)
    if (strategy) {
      try {
        strategy()
      } catch (fallbackError) {
        console.error('å¤‡é€‰æ–¹æ¡ˆä¹Ÿå¤±è´¥äº†:', fallbackError)
        this.useUltimateFallback()
      }
    }
  }
  
  private useUltimateFallback(): void {
    // æœ€åçš„å¤‡é€‰æ–¹æ¡ˆï¼šç¦ç”¨åŠ¨ç”»ï¼Œä»…æ˜¾ç¤ºé™æ€èŠ‚ç‚¹
    console.log('ä½¿ç”¨æœ€ç»ˆå¤‡é€‰æ–¹æ¡ˆï¼šç¦ç”¨åŠ¨ç”»åŠŸèƒ½')
    this.disableAnimations()
    this.showStaticWorkflow()
  }
}
```

## ğŸŒ ä¹ã€æµè§ˆå™¨å…¼å®¹æ€§å¤„ç†

### 9.1 æµè§ˆå™¨èƒ½åŠ›æ£€æµ‹
```typescript
class BrowserCompatibilityChecker {
  checkAnimationSupport(): CompatibilityReport {
    const support = {
      cssTransitions: this.checkCSSTransitions(),
      cssTransforms: this.checkCSSTransforms(),
      requestAnimationFrame: typeof requestAnimationFrame !== 'undefined',
      webAnimationsAPI: 'animate' in document.createElement('div'),
      performanceAPI: 'performance' in window,
      gpuAcceleration: this.checkGPUAcceleration()
    }
    
    return {
      isFullySupported: Object.values(support).every(Boolean),
      partialSupport: Object.values(support).some(Boolean),
      supportDetails: support,
      recommendedFallback: this.getRecommendedFallback(support)
    }
  }
  
  private checkCSSTransitions(): boolean {
    const element = document.createElement('div')
    return 'transition' in element.style ||
           'webkitTransition' in element.style ||
           'mozTransition' in element.style
  }
  
  private getRecommendedFallback(support: any): FallbackStrategy {
    if (!support.cssTransitions) {
      return 'NO_ANIMATIONS' // ä¸æ”¯æŒåŠ¨ç”»ï¼Œä»…é™æ€æ˜¾ç¤º
    }
    
    if (!support.requestAnimationFrame) {
      return 'TIMER_BASED' // ä½¿ç”¨ setTimeout æ›¿ä»£
    }
    
    if (!support.webAnimationsAPI) {
      return 'CSS_ONLY' // ä»…ä½¿ç”¨ CSS åŠ¨ç”»
    }
    
    return 'FULL_SUPPORT' // å®Œå…¨æ”¯æŒ
  }
}
```

## ğŸ”§ åã€å¼€å‘è°ƒè¯•å·¥å…·

### 10.1 åŠ¨ç”»è°ƒè¯•å™¨
```typescript
class AnimationDebugger {
  private debugMode: boolean = false
  private logHistory: DebugLog[] = []
  
  enableDebugMode(): void {
    this.debugMode = true
    this.addDebugControls()
    console.log('ğŸ”§ åŠ¨ç”»è°ƒè¯•æ¨¡å¼å·²å¯ç”¨')
  }
  
  private addDebugControls(): void {
    // æ·»åŠ è°ƒè¯•é¢æ¿åˆ°é¡µé¢
    const debugPanel = this.createDebugPanel()
    document.body.appendChild(debugPanel)
  }
  
  logPathExecution(path: string[], currentIndex: number): void {
    if (!this.debugMode) return
    
    const log: DebugLog = {
      timestamp: Date.now(),
      type: 'PATH_EXECUTION',
      data: {
        totalNodes: path.length,
        currentIndex,
        currentNodeId: path[currentIndex],
        remainingNodes: path.length - currentIndex - 1
      }
    }
    
    this.logHistory.push(log)
    console.log('ğŸ¯ åŠ¨ç”»è·¯å¾„æ‰§è¡Œ:', log.data)
  }
  
  logStyleChange(nodeId: string, fromState: string, toState: string): void {
    if (!this.debugMode) return
    
    console.log(`ğŸ¨ èŠ‚ç‚¹æ ·å¼å˜åŒ–: ${nodeId} [${fromState}] â†’ [${toState}]`)
  }
  
  exportDebugData(): DebugExport {
    return {
      logs: this.logHistory,
      summary: this.generateSummary(),
      timestamp: Date.now()
    }
  }
}
```

## ğŸ“‹ åä¸€ã€å®æ–½ç­–ç•¥

### 11.1 æ¸è¿›å¼è¿ç§»
```
ç¬¬ä¸€é˜¶æ®µï¼šä¿æŒç°æœ‰ from/to å­—æ®µï¼ŒåŒæ—¶æ·»åŠ  connections æ•°ç»„
ç¬¬äºŒé˜¶æ®µï¼šé€æ­¥å°†é€»è¾‘è¿ç§»åˆ° connections æ•°ç»„
ç¬¬ä¸‰é˜¶æ®µï¼šç§»é™¤ from/to å­—æ®µï¼Œå®Œå…¨ä½¿ç”¨æ–°ç»“æ„
```

### 11.2 å‘åå…¼å®¹å¤„ç†
```typescript
// å…¼å®¹æ€§è½¬æ¢å‡½æ•°
function convertLegacyNode(legacyNode: LegacyWorkflowNode): WorkflowNode {
  const newNode: WorkflowNode = {
    ...legacyNode,
    connections: []
  }
  
  // å°†from/toè½¬æ¢ä¸ºconnections
  if (legacyNode.to) {
    newNode.connections.push({
      id: `${legacyNode.id}-${legacyNode.to}`,
      fromNodeId: legacyNode.id,
      toNodeId: legacyNode.to,
      type: 'forward',
      label: 'æäº¤'
    })
  }
  
  return newNode
}
```

## ğŸ¯ åäºŒã€æ ¸å¿ƒä¼˜åŠ¿æ€»ç»“

### 12.1 è§£å†³çš„å…³é”®é—®é¢˜
1. **é©³å›é€»è¾‘ç®€åŒ–**ï¼šé€šè¿‡connectionsæ•°ç»„elegantlyå¤„ç†å¤æ‚æµç¨‹
2. **åŒå¤©å¤šè½®äº¤äº’**ï¼šactionSequence + timeDetailç²¾ç¡®æ§åˆ¶
3. **è§†è§‰é€»è¾‘æ¸…æ™°**ï¼šæ°´å¹³=æ—¶é—´è·¨åº¦ï¼Œå‚ç›´=åŒå¤©æ“ä½œ
4. **ç»“æŸçŠ¶æ€å‡†ç¡®**ï¼šæ˜ç¡®åŒºåˆ†çœŸæ­£ç»“æŸvsè¿›è¡Œä¸­çŠ¶æ€

### 12.2 æŠ€æœ¯åˆ›æ–°ç‚¹
1. **ç»Ÿä¸€èŠ‚ç‚¹ç³»ç»Ÿ**ï¼šå®¡æ ¸èŠ‚ç‚¹å’ŒåŠ¨ç”»èŠ‚ç‚¹å®Œå…¨ä¸€è‡´
2. **å¤šè¿æ¥æ¶æ„**ï¼šä»å•ä¸€from/toå‡çº§ä¸ºconnectionsæ•°ç»„
3. **æ™ºèƒ½è·¯å¾„æ„å»º**ï¼šä¸‰ç§ç­–ç•¥ä¿è¯åŠ¨ç”»é¡ºåºæ­£ç¡®æ€§
4. **è‡ªé€‚åº”å¸ƒå±€**ï¼šæ—¶é—´è½´æ ¹æ®ç»“æŸçŠ¶æ€æ™ºèƒ½é¢„ç•™ç©ºé—´

### 12.3 ç”¨æˆ·ä½“éªŒæå‡
1. **è§†è§‰åé¦ˆ**ï¼šç©ºå¿ƒâ†’å®å¿ƒâ†’åŠé€æ˜çš„çŠ¶æ€å˜åŒ–
2. **å¾ªç¯æ¼”ç¤º**ï¼šæŒç»­åŠ¨ç”»å¸®åŠ©ç†è§£å·¥ä½œæµ
3. **æ™ºèƒ½æ§åˆ¶**ï¼šæš‚åœ/ç»§ç»­/é‡æ–°å¼€å§‹ä¸‰ç§æ“ä½œ
4. **é”™è¯¯æ¢å¤**ï¼šå¤šå±‚çº§é™çº§æ–¹æ¡ˆä¿è¯ç¨³å®šæ€§

### 12.4 æ¶æ„ä¼˜åŠ¿
1. **å‘åå…¼å®¹**ï¼šä¿æŒç°æœ‰æ•°æ®ç»“æ„ï¼Œå¹³æ»‘è¿ç§»
2. **æ‰©å±•æ€§å¼º**ï¼šæ”¯æŒå¤æ‚çš„ä¸šåŠ¡æµç¨‹æ‰©å±•
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šGPUåŠ é€Ÿã€å†…å­˜ç®¡ç†ã€æ‰¹é‡å¤„ç†
4. **å¼€å‘å‹å¥½**ï¼šå®Œæ•´çš„ç±»å‹å®šä¹‰ã€è°ƒè¯•å·¥å…·ã€é”™è¯¯å¤„ç†

## ğŸš€ åä¸‰ã€é¢„æœŸæ•ˆæœ

é€šè¿‡è¿™ä¸ªæ–°çš„æ•°æ®ç»“æ„è®¾è®¡ï¼Œæˆ‘ä»¬èƒ½å¤Ÿï¼š

- **ç®€åŒ–å¤æ‚æµç¨‹**ï¼šé©³å›åç»§ç»­ç­‰å¤æ‚é€»è¾‘å˜å¾—ç®€å•æ˜ç¡®
- **æå‡ç”¨æˆ·ä½“éªŒ**ï¼šåŠ¨ç”»æ¼”ç¤ºè®©æµç¨‹æ›´ç›´è§‚æ˜“æ‡‚
- **æé«˜å¼€å‘æ•ˆç‡**ï¼šç»Ÿä¸€çš„æ•°æ®ç»“æ„å’Œç®—æ³•å‡å°‘é‡å¤ä»£ç 
- **å¢å¼ºç³»ç»Ÿç¨³å®šæ€§**ï¼šå®Œå–„çš„éªŒè¯å’Œé”™è¯¯å¤„ç†æœºåˆ¶
- **æ”¯æŒæœªæ¥æ‰©å±•**ï¼šä¸ºæ–°åŠŸèƒ½éœ€æ±‚æä¾›äº†åšå®åŸºç¡€

è¿™ä¸ªæ–¹æ¡ˆæ—¢è§£å†³äº†å½“å‰çš„æŠ€æœ¯ç—›ç‚¹ï¼Œåˆä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•å¥ å®šäº†è‰¯å¥½çš„æ¶æ„åŸºç¡€ã€‚ 